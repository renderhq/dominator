import { effect } from '@dominator/core';
import * as stateModule from '../state';

export const renderCanvas = () => {
  const { currentColor, tool, pixels, history, redoStack, GRID_SIZE, colorCounts, undo, redo, exportToPNG, startDrawing, ifDrawing, stopDrawing } = stateModule as any;
  const events = (window as any);
  const v0 = document.createElement('div');
  v0.setAttribute('class', "pixel-canvas-app");
  const v1 = document.createElement('header');
  const v2 = document.createElement('h1');
  const v3 = document.createTextNode("Dominator Pixel");
  v2.appendChild(v3);
  v1.appendChild(v2);
  const v4 = document.createElement('div');
  v4.setAttribute('class', "tools");
  const v5 = document.createElement('div');
  v5.setAttribute('class', "tool-group");
  const v6 = document.createElement('label');
  const v7 = document.createTextNode("Color");
  v6.appendChild(v7);
  v5.appendChild(v6);
  const v8 = document.createElement('input');
  v8.setAttribute('type', "color");
  effect(() => { v8.setAttribute('value', currentColor()); });
  v8.addEventListener('input', e => currentColor.set(e.target.value));
  v8.setAttribute('title', "Pick Color");
  v5.appendChild(v8);
  v4.appendChild(v5);
  const v9 = document.createElement('div');
  v9.setAttribute('class', "tool-group");
  const v10 = document.createElement('button');
  v10.addEventListener('click', e => tool.set('draw'));
  effect(() => { v10.setAttribute('class', tool() === 'draw' ? 'active' : ''); });
  const v11 = document.createTextNode("Draw");
  v10.appendChild(v11);
  v9.appendChild(v10);
  const v12 = document.createElement('button');
  v12.addEventListener('click', e => tool.set('erase'));
  effect(() => { v12.setAttribute('class', tool() === 'erase' ? 'active' : ''); });
  const v13 = document.createTextNode("Erase");
  v12.appendChild(v13);
  v9.appendChild(v12);
  v4.appendChild(v9);
  const v14 = document.createElement('div');
  v14.setAttribute('class', "tool-group");
  const v15 = document.createElement('button');
  v15.addEventListener('click', (e) => undo(e));
  effect(() => { v15.setAttribute('disabled', history().length === 0); });
  v15.setAttribute('title', "Undo (Ctrl+Z)");
  const v16 = document.createTextNode("Undo");
  v15.appendChild(v16);
  v14.appendChild(v15);
  const v17 = document.createElement('button');
  v17.addEventListener('click', (e) => redo(e));
  effect(() => { v17.setAttribute('disabled', redoStack().length === 0); });
  v17.setAttribute('title', "Redo (Ctrl+Y)");
  const v18 = document.createTextNode("Redo");
  v17.appendChild(v18);
  v14.appendChild(v17);
  v4.appendChild(v14);
  v1.appendChild(v4);
  v0.appendChild(v1);
  const v19 = document.createElement('main');
  const v20 = document.createElement('div');
  v20.setAttribute('class', "grid-container");
  const v21 = document.createElement('div');
  v21.setAttribute('class', "grid");
  v21.addEventListener('mousedown', e => { if (e.button === 0) startDrawing(e); });
  v21.addEventListener('mousemove', e => ifDrawing(e));
  v21.addEventListener('mouseup', (e) => stopDrawing(e));
  v21.addEventListener('mouseleave', (e) => stopDrawing(e));
  const v22 = document.createDocumentFragment();
  // Optimized grid generation
  for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
    const x = i % GRID_SIZE; const y = Math.floor(i / GRID_SIZE);
    const pixel = document.createElement('div');
    pixel.className = 'pixel';
    pixel.dataset.x = x.toString(); pixel.dataset.y = y.toString();
    effect(() => { pixel.style.backgroundColor = pixels()[`${x}-${y}`] || '#ffffff'; });
    v22.appendChild(pixel);
  }
  v21.appendChild(v22);
  v20.appendChild(v21);
  v19.appendChild(v20);
  const v23 = document.createElement('aside');
  v23.setAttribute('class', "sidebar");
  const v24 = document.createElement('section');
  v24.setAttribute('class', "stats-section");
  const v25 = document.createElement('h3');
  const v26 = document.createTextNode("History & Stats");
  v25.appendChild(v26);
  v24.appendChild(v25);
  const v27 = document.createElement('p');
  v27.setAttribute('class', "stats-summary");
  const v28 = document.createTextNode("Pixels colored:");
  v27.appendChild(v28);
  const v29 = document.createElement('strong');
  const v30 = document.createTextNode('');
  effect(() => { v30.textContent = String(Object.keys(pixels()).length); });
  v29.appendChild(v30);
  v27.appendChild(v29);
  v24.appendChild(v27);
  const v31 = document.createElement('h3');
  const v32 = document.createTextNode("Palette Usage");
  v31.appendChild(v32);
  v24.appendChild(v31);
  const v33 = document.createElement('div');
  v33.setAttribute('class', "color-usage");
  const v34 = document.createDocumentFragment();
  effect(() => {
    v34.textContent = '';
    colorCounts().forEach(([col, cnt]) => {
      const item = document.createElement('div');
      item.className = 'usage-item';
      item.style.setProperty('--color', col);
      item.innerHTML = `<div class="color-swatch"></div><span class="color-code">${col}</span><span class="color-count">${cnt}</span>`;
      v34.appendChild(item);
    });
  });
  v33.appendChild(v34);
  v24.appendChild(v33);
  v23.appendChild(v24);
  const v35 = document.createElement('div');
  v35.setAttribute('class', "sidebar-footer");
  const v36 = document.createElement('button');
  v36.setAttribute('class', "export-btn");
  v36.addEventListener('click', (e) => exportToPNG(e));
  const v37 = document.createTextNode("Export Artifact");
  v36.appendChild(v37);
  v35.appendChild(v36);
  v23.appendChild(v35);
  v19.appendChild(v23);
  v0.appendChild(v19);
  return v0;
};